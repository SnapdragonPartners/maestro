# Bootstrap System Design

## Overview

This document describes the design and implementation of the bootstrap system for the multi-agent coding orchestrator. The bootstrap system solves the Makefile dependency issue and provides a robust foundation for project setup.

## Problem Statement

The current system has several critical issues:
- Coder agents assume `make build`, `make test`, `make run`, `make lint` targets exist
- New/empty projects don't have Makefiles
- Multiple coders creating Makefiles simultaneously causes merge conflicts
- Complex existing Makefiles need adaptation in unpredictable ways
- No standardized way to handle different languages/toolchains

## Solution Architecture

### 1. PROJECT_BOOTSTRAP Phase

**Core Concept**: Treat project setup as a **blocking orchestrator phase**, not a regular story.

**Implementation**:
- New orchestrator phase `PROJECT_BOOTSTRAP` that runs before any stories
- Architect creates Story 000 markdown file, but dispatcher marks it as **blocking**
- No coder agents receive tasks until bootstrap story is in `DONE` state
- Bootstrap artifacts committed to dedicated `bootstrap-init` branch
- Auto-merge to `main` provides single source of truth before other branches spawn

**Benefits**:
- Guarantees build infrastructure exists before any coder starts
- Eliminates merge conflicts on build files
- Provides consistent foundation for all subsequent work

### 2. Orchestrator-Level BuildBackend System

**Core Concept**: Move build execution to orchestrator, keeping agents decoupled from tooling.

**Interface**:
```go
type BuildBackend interface {
    Name() string
    Detect(root string) bool
    Build(ctx context.Context, root string, stream io.Writer) error
    Test(ctx context.Context, root string, stream io.Writer) error
    Lint(ctx context.Context, root string, stream io.Writer) error
    Run(ctx context.Context, root string, args []string, stream io.Writer) error
}
```

**Execution Flow**:
1. Orchestrator calls `SelectBackend()` once per project
2. Backend name passed to agents in TASK payload
3. Agents call orchestrator to execute build/test/lint operations
4. Orchestrator handles actual tool execution with streaming output

**Backend Types**:
- **GoBackend**: `go test`, `go build`, `golangci-lint run`
- **NodeBackend**: `npm test`, `npm run build`, `eslint`
- **PythonBackend**: `pytest`, `python -m build`, `flake8`
- **MakeBackend**: `make test`, `make build`, `make lint`
- **NullBackend**: No-op for empty repos, returns success

### 3. Conflict-Free Makefile Strategy

**Primary Approach: Include File Pattern**
```makefile
# Root Makefile (human-maintained, never changes)
-include agent.mk

# Default targets if agent.mk doesn't exist
.PHONY: build test lint run
build:
	@echo "No build configured"
test:
	@echo "No tests configured"
lint:
	@echo "No linting configured"
run:
	@echo "No run target configured"
```

**Generated agent.mk**:
```makefile
# Generated by Claude Code Orchestrator
.PHONY: build test lint run
build:
	go build ./...
test:
	go test ./...
lint:
	golangci-lint run ./...
run:
	go run ./cmd/myapp
```

**Fallback: Delimited Sections**
```makefile
# >>> AUTO-GEN: CLAUDE
.PHONY: lint
lint: @golangci-lint run ./...
# <<< AUTO-GEN: CLAUDE
```

With `.gitattributes`:
```
Makefile merge=union
agent.mk merge=union
```

### 4. Bootstrap Artifacts

The bootstrap phase creates comprehensive project infrastructure:

**Build System**:
- `Makefile` with include pattern
- `agent.mk` with backend-specific targets
- Language-specific configs (e.g., `go.mod`, `package.json`)

**Development Environment**:
- `.gitignore` appropriate for language
- `.editorconfig` for consistent formatting
- Version pinning files (`.nvmrc`, `go.work`, `pyproject.toml`)

**Quality Assurance**:
- Linter configurations (`golangci-lint.yaml`, `.eslintrc.*`)
- Pre-commit hooks setup
- CI workflow (`.github/workflows/ci.yaml`)

**Documentation**:
- `README.md` skeleton
- `CONTRIBUTING.md` guidelines
- `LICENSE` file

**Optional**:
- `Dockerfile` for containerized workflows
- Dev container manifest
- Docker Compose for local development

### 5. Merge Conflict Prevention

**Single Writer Rule**: Only architect or dedicated build-maintenance stories can modify build artifacts.

**Git Worktree Isolation**: Coder branches always start from up-to-date base via orchestrator rebasing.

**Union Merge Strategy**: Build files use union merge driver to eliminate text-level conflicts.

**Build Files Lock**: Dispatcher enforces exclusive access to build artifacts, escalating violations.

## Implementation Plan

### Phase 1: Core Bootstrap Infrastructure
- [ ] Implement `PROJECT_BOOTSTRAP` orchestrator phase
- [ ] Create Story 000 blocking mechanism in dispatcher
- [ ] Add bootstrap branch creation and auto-merge logic
- [ ] Design bootstrap artifact templates

### Phase 2: BuildBackend System
- [ ] Create `pkg/build/` package with registry and detection
- [ ] Implement `BuildBackend` interface and base backends
- [ ] Add NullBackend for empty repos
- [ ] Add MakeBackend for existing Makefile projects
- [ ] Implement backend selection and caching

### Phase 3: Backend Implementations
- [ ] Implement GoBackend with `go.mod` detection
- [ ] Implement NodeBackend with `package.json` detection
- [ ] Implement PythonBackend with `pyproject.toml` detection
- [ ] Add backend-specific artifact generation

### Phase 4: Integration
- [ ] Update coder templates to use backend info from TASK payload
- [ ] Refactor `runMakeTest` to use backend abstraction
- [ ] Add orchestrator build execution endpoints
- [ ] Update architect to include language detection in stories

### Phase 5: Testing and Validation
- [ ] Create smoke test: empty repo → orchestrator run → health endpoint story
- [ ] Test with existing projects (Go, Node, Python)
- [ ] Validate conflict-free Makefile updates
- [ ] Performance testing with multiple concurrent agents

### Phase 6: Documentation and Deployment
- [ ] Update README with bootstrap requirements
- [ ] Create migration guide for existing projects
- [ ] Add troubleshooting guide for bootstrap failures
- [ ] Update agent templates documentation

## Configuration Options

```json
{
  "bootstrap": {
    "enabled": true,
    "force_backend": "go",           // Override auto-detection
    "skip_makefile": false,          // Skip Makefile generation
    "additional_artifacts": [        // Custom artifacts to generate
      ".dockerignore",
      "docker-compose.yml"
    ],
    "template_overrides": {          // Custom templates
      "gitignore": "custom-gitignore.template"
    }
  }
}
```

## Benefits

**Eliminates Makefile Dependency Issues**:
- No assumptions about existing build files
- Consistent build interface across all projects
- Automatic language/toolchain detection

**Prevents Merge Conflicts**:
- Single writer rule for build files
- Include file pattern preserves human Makefiles
- Bootstrap phase eliminates initialization races

**Supports All Project Types**:
- Empty repositories (NullBackend)
- Existing projects (detection + appropriate backend)
- Complex/custom toolchains (extensible backend system)

**Maintains Flexibility**:
- Easy to add new language backends
- Preserves existing project structure
- Optional Makefile generation

**Improves Developer Experience**:
- Consistent build commands across projects
- Automatic setup of development environment
- Comprehensive CI/CD integration

## Migration Strategy

**For New Projects**: Bootstrap runs automatically, no migration needed.

**For Existing Projects**: 
1. Run bootstrap in "detection mode" to identify current toolchain
2. Generate `agent.mk` with detected backend
3. Update root Makefile to include `agent.mk`
4. Preserve existing targets and customizations

**For Projects with Complex Makefiles**:
1. Use include file pattern exclusively
2. Generate minimal `agent.mk` with standard targets
3. Existing Makefile remains untouched
4. Gradual migration of targets to `agent.mk` as needed

## Troubleshooting

**Bootstrap Fails**: Check language detection logs, verify required tools installed.

**Build Commands Fail**: Verify backend selection, check tool availability in PATH.

**Merge Conflicts on Build Files**: Ensure single writer rule enforcement, check union merge configuration.

**Backend Detection Wrong**: Use `force_backend` configuration option, file issue for detection improvement.

## Future Enhancements

- Support for polyglot projects (multiple backends)
- Custom backend plugins
- Integration with external build systems (Bazel, Buck)
- Remote build execution
- Build caching and optimization
- Dependency vulnerability scanning integration

## Current TODO List

### Phase 1: Core Bootstrap Infrastructure
- [ ] Implement PROJECT_BOOTSTRAP orchestrator phase
- [ ] Create Story 000 blocking mechanism in dispatcher  
- [ ] Add bootstrap branch creation and auto-merge logic
- [ ] Design bootstrap artifact templates

### Phase 2: BuildBackend System
- [ ] Create pkg/build/ package with registry and detection
- [ ] Implement BuildBackend interface and base backends
- [ ] Add NullBackend for empty repos
- [ ] Add MakeBackend for existing Makefile projects
- [ ] Implement backend selection and caching

### Phase 3: Backend Implementations  
- [ ] Implement GoBackend with go.mod detection
- [ ] Implement NodeBackend with package.json detection
- [ ] Implement PythonBackend with pyproject.toml detection
- [ ] Add backend-specific artifact generation

### Phase 4: Integration
- [ ] Update coder templates to use backend info from TASK payload
- [ ] Refactor runMakeTest to use backend abstraction
- [ ] Add orchestrator build execution endpoints
- [ ] Update architect to include language detection in stories

### Phase 5: Testing and Validation
- [ ] Create smoke test: empty repo → orchestrator run → health endpoint story
- [ ] Test with existing projects (Go, Node, Python)
- [ ] Validate conflict-free Makefile updates
- [ ] Performance testing with multiple concurrent agents

### Phase 6: Documentation and Deployment
- [ ] Update README with bootstrap requirements
- [ ] Create migration guide for existing projects
- [ ] Add troubleshooting guide for bootstrap failures
- [ ] Update agent templates documentation

## Implementation Notes

**Current Priority**: Focus on Phase 1 and Phase 2 to establish the core infrastructure.

**Testing Strategy**: Use existing maestro project as test case for bootstrap system.

**Risk Mitigation**: Implement feature flags to allow gradual rollout and easy rollback.