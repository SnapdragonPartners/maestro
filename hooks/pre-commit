#!/bin/bash

# Pre-commit check script for maestro
# Ensures build passes and all linting issues are resolved

set -e

echo "üî® Pre-commit checks for maestro..."

# 1. Ensure build passes
echo "1. Checking build..."
if ! make build >/dev/null 2>&1; then
    echo "‚ùå Build failed! Fix build errors before committing."
    exit 1
fi
echo "‚úÖ Build passed"

# 2. Run core tests (with timeout)
echo "2. Running core tests..."
if ! go test -cover -timeout=300s ./... >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Tests timed out or failed. Consider running 'make test' manually."
    exit 1
fi
echo "‚úÖ Tests completed"

# 3. Run comprehensive linting
echo "3. Running comprehensive linting..."
set +e
LINT_OUTPUT=$(make lint 2>&1)
LINT_EXIT_CODE=$?
set -e

if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå BLOCKING: Linting issues found. All lint errors must be resolved before committing."
    echo ""
    echo "Lint output:"
    echo "$LINT_OUTPUT"
    echo ""
    echo "üí° Run 'make lint' to see all issues, then fix them before committing."
    exit 1
fi

echo "‚úÖ All linting checks passed!"
echo "‚úÖ Pre-commit checks completed successfully!"
exit 0
